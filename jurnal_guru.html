<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjurnalan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSS Anda sudah sangat baik, tidak ada perubahan signifikan di sini */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header .icon {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-container, .data-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            font-size: 1.3rem;
            color: #333;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #2ecc71 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .data-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .data-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            color: #333;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #555;
            margin: 0;
        }
        
        .filter-group select {
            min-width: 150px;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        th.sortable::after {
            content: ' ↕️';
            font-size: 12px;
        }
        
        th.sort-asc::after {
            content: ' ⬆️';
            font-size: 12px;
        }
        
        th.sort-desc::after {
            content: ' ⬇️';
            font-size: 12px;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-hadir { background: #d4edda; color: #155724; }
        .status-tidak-hadir { background: #f8d7da; color: #721c24; }
        .status-sakit { background: #fff3cd; color: #856404; }
        .status-izin { background: #cce7ff; color: #004085; }
        .status-selesai { background: #d4edda; color: #155724; }
        .status-tidak-selesai { background: #f8d7da; color: #721c24; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .data-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-buttons {
                justify-content: center;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <span class="icon">📚</span>
                Aplikasi Penjurnalan
            </h1>
            <p>Sistem pencatatan kegiatan pembelajaran</p>
			<p>SD Negeri 40 Kecamatan Pontianak Utara</p>
        </header>

        <div class="form-container">
            <div class="form-title">
                <span>✏️</span>
                Tambah Data Jurnal
            </div>
            
            <form id="journalForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tanggal">Tanggal</label>
                        <input type="date" id="tanggal" name="tanggal" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="kelas">Kelas</label>
                        <select id="kelas" name="kelas" required>
                            <option value="">Pilih Kelas</option>
                            <option value="1">KELAS 1</option>
                            <option value="2 A">KELAS 2 A</option>
                            <option value="2 B">KELAS 2 B</option>
                            <option value="3 A">KELAS 3 A</option>
                            <option value="3 B">KELAS 3 B</option>
                            <option value="4 A">KELAS 4 A</option>
                            <option value="4 B">KELAS 4 B</option>
                            <option value="5 A">KELAS 5 A</option>
                            <option value="5 B">KELAS 5 B</option>
                            <option value="6 A">KELAS 6 A</option>
                            <option value="6 B">KELAS 6 B</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mata_pelajaran">Mata Pelajaran</label>
                        <select id="mata_pelajaran" name="mata_pelajaran" required>
                            <option value="">Pilih Mata Pelajaran</option>
                            <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option>
                            <option value="Pendidikan Agama Buddha">Pendidikan Agama Buddha</option>
                            <option value="Pendidikan Agama Kristen">Pendidikan Agama Kristen</option>
                            <option value="Pendidikan Pancasila dan Kewarganegaraan">Pendidikan Pancasila dan Kewarganegaraan</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Ilmu Pengetahuan Alam dan Sosial">Ilmu Pengetahuan Alam dan Sosial</option>
                            <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan">Pendidikan Jasmani, Olahraga, dan Kesehatan</option>
                            <option value="Seni Musik">Seni Musik</option>
                            <option value="Seni Tari">Seni Tari</option>
                            <option value="Seni Rupa">Seni Rupa</option>
                            <option value="Seni Teater">Seni Teater</option>
                            <option value="Seni Budaya">Seni Budaya</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam_mulai">Jam Mulai</label>
                        <input type="time" id="jam_mulai" name="jam_mulai" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="jam_selesai">Jam Selesai</label>
                        <input type="time" id="jam_selesai" name="jam_selesai" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" required>
                            <option value="">Pilih Status</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Tidak Selesai">Tidak Selesai</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="materi">Materi</label>
                        <textarea id="materi" name="materi" placeholder="Masukkan materi pembelajaran" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="tidak_hadir">Tidak Hadir</label>
                        <input type="text" id="tidak_hadir" name="tidak_hadir" placeholder="Nama siswa yang tidak hadir">
                    </div>
                    
                    <div class="form-group">
                        <label for="catatan">Catatan</label>
                        <textarea id="catatan" name="catatan" placeholder="Catatan tambahan..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span>💾</span>
                    Simpan Data
                </button>
            </form>
        </div>

        <div class="data-container">
            <div class="data-controls">
                <div class="data-title">
                    <span>📊</span>
                    Data Penjurnalan
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="loadData()">
                        <span>🔄</span>
                        Muat Ulang
                    </button>
                    <button class="btn btn-warning" onclick="downloadExcel()">
                        <span>📊</span>
                        Download Excel
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()">
                        <span>🗑️</span>
                        Hapus Semua
                    </button>
                </div>
            </div>
            
            <div class="summary-cards" id="summaryCards" style="display: none;">
                <div class="summary-card">
                    <h3 id="totalEntries">0</h3>
                    <p>Total Jurnal</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalClasses">0</h3>
                    <p>Total Kelas</p>
                </div>
                <div class="summary-card">
                    <h3 id="completedLessons">0</h3>
                    <p>Selesai</p>
                </div>
                <div class="summary-card">
                    <h3 id="incompleteLessons">0</h3>
                    <p>Tidak Selesai</p>
                </div>
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterKelas">Filter Kelas:</label>
                    <select id="filterKelas" onchange="filterData()">
                        <option value="">Semua Kelas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterMapel">Filter Mata Pelajaran:</label>
                    <select id="filterMapel" onchange="filterData()">
                        <option value="">Semua Mata Pelajaran</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Urutkan:</label>
                    <select id="sortBy" onchange="sortData()">
                        <option value="tanggal">Tanggal</option>
                        <option value="jam_mulai">Jam Mulai</option>
                        <option value="jam_selesai">Jam Selesai</option>
                        <option value="kelas">Kelas</option>
                        <option value="mata_pelajaran">Mata Pelajaran</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortOrder">Urutan:</label>
                    <select id="sortOrder" onchange="sortData()">
                        <option value="asc">A-Z / Terlama</option>
                        <option value="desc">Z-A / Terbaru</option>
                    </select>
                </div>
            </div>
            
            <div id="alertContainer"></div>
            
            <div class="table-container">
                <div id="loadingContainer" class="loading">
                    <div class="spinner"></div>
                    <p>Memuat data dari Google Sheets...</p>
                </div>
                
                <table id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="tanggal">Tanggal</th>
                            <th class="sortable" data-column="kelas">Kelas</th>
                            <th class="sortable" data-column="mata_pelajaran">Mata Pelajaran</th>
                            <th class="sortable" data-column="jam_mulai">Jam Mulai</th>
                            <th class="sortable" data-column="jam_selesai">Jam Selesai</th>
                            <th class="sortable" data-column="materi">Materi</th>
                            <th class="sortable" data-column="status">Status</th>
                            <th>Tidak Hadir</th>
                            <th>Catatan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="icon">📋</div>
                    <h3>Belum ada data</h3>
                    <p>Mulai tambahkan data jurnal pembelajaran Anda</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi Google Apps Script
        // PASTIKAN URL INI BENAR DAN SKRIP ANDA SUDAH DI-DEPLOY DENGAN IZIN AKSES 'Anyone'
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfBXjTFWaAlZXuLBLJqPnj83pg1OfPHO8540uf25hIewbJsFqRsI3jqr344vEAkt1i9w/exec'; // URL yang Anda berikan

        let currentData = []; // Data mentah dari Google Sheets (termasuk header)
        let processedData = []; // Data yang sudah diproses (tanpa header, dengan nama kolom yang jelas)
        let filteredData = []; // Data yang sudah difilter dan siap dirender
        let currentSort = { column: 'tanggal', order: 'desc' }; // Default sorting

        // Dapatkan referensi ke tombol submit
        const submitButton = document.getElementById('submitBtn');

        // Set tanggal hari ini sebagai default saat halaman dimuat
        document.getElementById('tanggal').valueAsDate = new Date();

        // Event listener untuk form submit
        document.getElementById('journalForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Mencegah pengiriman form default
            // Validasi form sebelum mengirim data
            if (!validateForm()) {
                showAlert('Harap lengkapi semua kolom yang wajib diisi.', 'error');
                return;
            }
            await addData();
        });

        // Event listener untuk sorting pada header tabel
        document.addEventListener('DOMContentLoaded', function() {
            // Inisialisasi event listener untuk header tabel yang bisa diurutkan
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    if (currentSort.column === column) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.order = 'asc'; // Default ke ascending saat kolom baru dipilih
                    }
                    updateSortHeaders(); // Perbarui ikon sorting di header
                    renderTable(); // Render ulang tabel dengan urutan baru
                });
            });
            
            // Muat data saat halaman pertama kali dimuat
            loadData();
        });

        // Fungsi untuk validasi form sisi klien
        function validateForm() {
            const form = document.getElementById('journalForm');
            const requiredInputs = form.querySelectorAll('[required]');
            let isValid = true;
            requiredInputs.forEach(input => {
                if (!input.value) {
                    isValid = false;
                    input.style.borderColor = 'red'; // Beri tanda merah pada input yang kosong
                } else {
                    input.style.borderColor = ''; // Kembalikan warna border jika sudah terisi
                }
            });
            return isValid;
        }

        // Fungsi untuk menambah data
        async function addData() {
            const form = document.getElementById('journalForm');
            const formData = new FormData(form);
            
            // Nonaktifkan tombol submit untuk mencegah pengiriman ganda
            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';

            const data = {
                action: 'add',
                tanggal: formData.get('tanggal'),
                mata_pelajaran: formData.get('mata_pelajaran'),
                jam_mulai: formData.get('jam_mulai'),
                jam_selesai: formData.get('jam_selesai'),
                kelas: formData.get('kelas'),
                status: formData.get('status'),
                materi: formData.get('materi'),
                tidak_hadir: formData.get('tidak_hadir') || '', // Pastikan string kosong jika tidak diisi
                catatan: formData.get('catatan') || '' // Pastikan string kosong jika tidak diisi
            };
            
            try {
                showAlert('Menyimpan data...', 'success');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data).toString()
                });
                
                // Periksa apakah respons HTTP berhasil (status 2xx)
                if (!response.ok) {
                    const errorText = await response.text(); // Coba ambil teks error dari respons
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Data berhasil ditambahkan!', 'success');
                    form.reset(); // Reset form setelah berhasil
                    document.getElementById('tanggal').valueAsDate = new Date(); // Set tanggal kembali ke hari ini
                    await loadData(); // Muat ulang data untuk menampilkan entri baru
                } else {
                    showAlert('Gagal menambahkan data: ' + (result.message || 'Terjadi kesalahan tidak diketahui.'), 'error');
                }
            } catch (error) {
                console.error('Error adding data:', error);
                showAlert('Terjadi kesalahan saat menyimpan data: ' + error.message, 'error');
            } finally {
                // Aktifkan kembali tombol submit setelah proses selesai
                submitButton.disabled = false;
                submitButton.innerHTML = '<span>💾</span> Simpan Data';
            }
        }

        // Fungsi untuk memuat data dari Google Sheets
        async function loadData() {
            const loadingContainer = document.getElementById('loadingContainer');
            const dataTable = document.getElementById('dataTable');
            const emptyState = document.getElementById('emptyState');
            const summaryCards = document.getElementById('summaryCards');
            
            // Tampilkan indikator loading dan sembunyikan elemen lain
            loadingContainer.style.display = 'block';
            dataTable.style.display = 'none';
            emptyState.style.display = 'none';
            summaryCards.style.display = 'none';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data || []; // Simpan data mentah
                    
                    if (currentData.length <= 1) { // Hanya header atau tidak ada data
                        loadingContainer.style.display = 'none';
                        emptyState.style.display = 'block';
                        processedData = []; // Pastikan data kosong
                        filteredData = [];
                        updateSummary(); // Perbarui ringkasan ke 0
                        return;
                    }
                    
                    // Proses data: hapus baris header dan petakan ke objek dengan nama kolom yang jelas
                    // Asumsi urutan kolom di Google Sheet: A=Timestamp, B=Tanggal, C=Mata Pelajaran, D=Jam Mulai, E=Jam Selesai, F=Kelas, G=Status, H=Materi, I=Tidak Hadir, J=Catatan
                    const dataRows = currentData.slice(1); // Ambil semua baris kecuali header
                    processedData = dataRows.map((row, index) => ({
                        originalIndex: index + 1,        // Index baris data dalam array (dimulai dari 1)
                        actualRowIndex: index + 2,       // Index baris di Google Sheets (dimulai dari 2 karena baris 1 adalah header)
                        tanggal: row[1] || '',           // Kolom B
                        mata_pelajaran: row[2] || '',    // Kolom C
                        jam_mulai: row[3] || '',         // Kolom D
                        jam_selesai: row[4] || '',       // Kolom E
                        kelas: row[5] || '',             // Kolom F
                        status: row[6] || '',            // Kolom G
                        materi: row[7] || '',            // Kolom H
                        tidak_hadir: row[8] || '',       // Kolom I
                        catatan: row[9] || ''            // Kolom J
                    }));
                    
                    // Terapkan filter dan sorting awal
                    filterData(); // Ini akan memperbarui filteredData dan memanggil renderTable()
                    updateFilterOptions(); // Perbarui opsi dropdown filter
                    updateSummary(); // Perbarui kartu ringkasan
                    
                    loadingContainer.style.display = 'none';
                    dataTable.style.display = 'table';
                    summaryCards.style.display = 'grid';
                } else {
                    throw new Error(result.message || 'Gagal memuat data dari server.');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                loadingContainer.style.display = 'none';
                showAlert('Gagal memuat data: ' + error.message, 'error');
                emptyState.style.display = 'block'; // Tampilkan empty state jika gagal memuat
            }
        }

        // Fungsi untuk update opsi filter dropdown (Kelas dan Mata Pelajaran)
        function updateFilterOptions() {
            const filterKelasSelect = document.getElementById('filterKelas');
            const filterMapelSelect = document.getElementById('filterMapel');
            const kelasSet = new Set();
            const mapelSet = new Set();
            
            processedData.forEach(item => {
                if (item.kelas) {
                    kelasSet.add(item.kelas);
                }
                if (item.mata_pelajaran) {
                    mapelSet.add(item.mata_pelajaran);
                }
            });
            
            // Sortir kelas secara numerik lalu alfabetis
            const sortedKelas = Array.from(kelasSet).sort((a, b) => {
                const aNum = parseInt(a);
                const bNum = parseInt(b);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    if (aNum !== bNum) return aNum - bNum;
                }
                return a.localeCompare(b);
            });
            
            // Isi ulang dropdown filter Kelas
            const currentSelectedKelas = filterKelasSelect.value; // Simpan pilihan saat ini
            filterKelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
            sortedKelas.forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas;
                option.textContent = kelas;
                filterKelasSelect.appendChild(option);
            });
            filterKelasSelect.value = currentSelectedKelas; // Kembalikan pilihan sebelumnya

            // Sortir mata pelajaran secara alfabetis
            const sortedMapel = Array.from(mapelSet).sort();
            
            // Isi ulang dropdown filter Mata Pelajaran
            const currentSelectedMapel = filterMapelSelect.value; // Simpan pilihan saat ini
            filterMapelSelect.innerHTML = '<option value="">Semua Mata Pelajaran</option>';
            sortedMapel.forEach(mapel => {
                const option = document.createElement('option');
                option.value = mapel;
                option.textContent = mapel;
                filterMapelSelect.appendChild(option);
            });
            filterMapelSelect.value = currentSelectedMapel; // Kembalikan pilihan sebelumnya
        }

        // Fungsi untuk update kartu ringkasan data
        function updateSummary() {
            const totalEntries = filteredData.length;
            const uniqueClasses = new Set(filteredData.map(item => item.kelas)).size;
            const completedLessons = filteredData.filter(item => item.status === 'Selesai').length;
            const incompleteLessons = filteredData.filter(item => item.status === 'Tidak Selesai').length;
            
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('totalClasses').textContent = uniqueClasses;
            document.getElementById('completedLessons').textContent = completedLessons;
            document.getElementById('incompleteLessons').textContent = incompleteLessons;
        }

        // Fungsi untuk filter data berdasarkan pilihan dropdown
        function filterData() {
            const filterKelas = document.getElementById('filterKelas').value;
            const filterMapel = document.getElementById('filterMapel').value;
            
            let tempFilteredData = [...processedData]; // Mulai dengan semua data yang sudah diproses
            
            // Terapkan filter Kelas
            if (filterKelas) {
                tempFilteredData = tempFilteredData.filter(item => item.kelas === filterKelas);
            }
            
            // Terapkan filter Mata Pelajaran
            if (filterMapel) {
                tempFilteredData = tempFilteredData.filter(item => item.mata_pelajaran === filterMapel);
            }
            
            filteredData = tempFilteredData; // Perbarui data yang difilter
            updateSummary(); // Perbarui ringkasan setelah filter
            renderTable(); // Render ulang tabel dengan data yang difilter
        }

        // Fungsi untuk sorting data
        function sortData() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            currentSort = { column: sortBy, order: sortOrder };
            updateSortHeaders(); // Perbarui ikon sorting di header
            renderTable(); // Render ulang tabel dengan urutan baru
        }

        // Fungsi untuk update ikon sorting di header tabel
        function updateSortHeaders() {
            document.querySelectorAll('th.sortable').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                const column = header.getAttribute('data-column');
                if (column === currentSort.column) {
                    header.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Fungsi untuk merender data ke dalam tabel HTML
        function renderTable() {
            const dataBody = document.getElementById('dataBody');
            const emptyState = document.getElementById('emptyState');
            const dataTable = document.getElementById('dataTable');
            
            if (filteredData.length === 0) {
                dataTable.style.display = 'none';
                emptyState.style.display = 'block';
                dataBody.innerHTML = ''; // Pastikan body tabel kosong
                return;
            }
            
            // Salin data yang difilter dan urutkan
            const sortedData = [...filteredData].sort((a, b) => {
                let aValue = a[currentSort.column];
                let bValue = b[currentSort.column];
                
                // Penanganan khusus untuk sorting tanggal dan waktu
                if (currentSort.column === 'tanggal') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else if (currentSort.column === 'jam_mulai' || currentSort.column === 'jam_selesai') {
                    // Konversi waktu ke format yang bisa dibandingkan (misal: menit dari tengah malam)
                    const timeToMinutes = (timeStr) => {
                        if (!timeStr) return 0;
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        return hours * 60 + minutes;
                    };
                    aValue = timeToMinutes(aValue);
                    bValue = timeToMinutes(bValue);
                }
                
                // Logika sorting
                if (aValue < bValue) return currentSort.order === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            
            dataBody.innerHTML = ''; // Kosongkan isi tabel sebelum mengisi ulang
            sortedData.forEach((item) => {
                const tr = document.createElement('tr');
                const statusClass = getStatusClass(item.status);
                
                // actualRowIndex digunakan untuk menghapus baris yang benar di Google Sheets
                const actualRowIndex = item.actualRowIndex;
                
                tr.innerHTML = `
                    <td>${formatDate(item.tanggal)}</td>
                    <td>${item.kelas || '-'}</td>
                    <td>${item.mata_pelajaran || '-'}</td>
                    <td>${formatTime(item.jam_mulai) || '-'}</td>
                    <td>${formatTime(item.jam_selesai) || '-'}</td>
                    <td>${item.materi || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || '-'}</span></td>
                    <td>${item.tidak_hadir || '-'}</td>
                    <td>${item.catatan || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRow(${actualRowIndex})" title="Hapus baris ${actualRowIndex}">
                            <span>🗑️</span>
                            Hapus
                        </button>
                    </td>
                `;
                dataBody.appendChild(tr);
            });
            
            dataTable.style.display = 'table';
            emptyState.style.display = 'none';
        }

        // Fungsi untuk menghapus satu baris data
        async function deleteRow(rowIndex) {
            console.log('Attempting to delete row with actual Google Sheet index:', rowIndex);
            
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            
            try {
                showAlert('Menghapus data...', 'success');
                
                const deleteData = {
                    action: 'delete',
                    row: rowIndex // Kirim actualRowIndex ke Apps Script
                };
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(deleteData).toString()
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Data berhasil dihapus!', 'success');
                    await loadData(); // Muat ulang data setelah penghapusan
                } else {
                    showAlert('Gagal menghapus data: ' + (result.message || 'Terjadi kesalahan tidak diketahui.'), 'error');
                }
            } catch (error) {
                console.error('Error deleting row:', error);
                showAlert('Terjadi kesalahan saat menghapus data: ' + error.message, 'error');
            }
        }

        // Fungsi untuk menghapus semua data
        async function deleteAllData() {
            if (!confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) return;
            
            console.log('Attempting to delete all data.');
            
            try {
                showAlert('Menghapus semua data...', 'success');
                
                const deleteAllDataPayload = {
                    action: 'deleteAll'
                };
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(deleteAllDataPayload).toString()
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Semua data berhasil dihapus!', 'success');
                    await loadData(); // Muat ulang data setelah penghapusan massal
                } else {
                    showAlert('Gagal menghapus semua data: ' + (result.message || 'Terjadi kesalahan tidak diketahui.'), 'error');
                }
            } catch (error) {
                console.error('Error deleting all data:', error);
                showAlert('Terjadi kesalahan saat menghapus semua data: ' + error.message, 'error');
            }
        }

        // Fungsi helper untuk mendapatkan kelas CSS berdasarkan status
        function getStatusClass(status) {
            const statusMap = {
                'Hadir': 'status-hadir',
                'Tidak Hadir': 'status-tidak-hadir',
                'Sakit': 'status-sakit',
                'Izin': 'status-izin',
                'Selesai': 'status-selesai',
                'Tidak Selesai': 'status-tidak-selesai'
            };
            return statusMap[status] || '';
        }
		
        // Fungsi helper untuk memformat waktu menjadi HH.MM
        function formatTime(timeValue) {
            if (timeValue === undefined || timeValue === null || timeValue === '') return '-';

            // Jika timeValue adalah string ISO 8601 (misal: "1899-12-30T03:52:48.000Z")
            // atau string HH:MM (misal: "07:00")
            try {
                let date;
                if (typeof timeValue === 'string' && timeValue.includes('T')) {
                    // Ini adalah format ISO 8601 dari Google Sheets untuk waktu
                    date = new Date(timeValue);
                } else if (typeof timeValue === 'string' && /^\d{1,2}:\d{2}$/.test(timeValue)) {
                    // Ini adalah format HH:MM yang mungkin sudah ada
                    const [hours, minutes] = timeValue.split(':').map(Number);
                    date = new Date(); // Gunakan tanggal saat ini sebagai dasar
                    date.setHours(hours, minutes, 0, 0);
                } else if (typeof timeValue === 'number') {
                    // Ini adalah nilai numerik dari Google Sheets yang merepresentasikan waktu
                    // 1 hari = 1, jadi 0.25 = 6 jam.
                    const totalMinutes = Math.round(timeValue * 24 * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    date = new Date();
                    date.setHours(hours, minutes, 0, 0);
                } else {
                    return String(timeValue); // Kembalikan apa adanya jika format tidak dikenal
                }

                if (isNaN(date.getTime())) {
                    return String(timeValue); // Jika parsing gagal, kembalikan string asli
                }

                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}.${minutes}`; // Format hh.mm
            } catch (error) {
                console.error("Error formatting time:", timeValue, error);
                return String(timeValue); // Fallback jika ada error
            }
        }

        // Fungsi helper untuk memformat tanggal
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                // Pastikan tanggal valid sebelum memformat
                if (isNaN(date.getTime())) {
                    return dateStr; // Kembalikan string asli jika tanggal tidak valid
                }
                return date.toLocaleDateString('id-ID', {
                    weekday: 'short', // Misal: Sen
                    year: 'numeric',
                    month: 'short',   // Misal: Jan
                    day: 'numeric'
                });
            } catch (error) {
                return dateStr; // Kembalikan string asli jika ada error
            }
        }

        // Fungsi helper untuk menampilkan alert (notifikasi)
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = ''; // Hapus alert sebelumnya
            container.appendChild(alert);
            
            // Hapus alert secara otomatis setelah 5 detik
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Fungsi untuk download data ke Excel
        function downloadExcel() {
            if (filteredData.length === 0) {
                showAlert('Tidak ada data untuk didownload', 'error');
                return;
            }
            
            // Siapkan data untuk Excel
            const excelData = [];
            
            // Tambahkan header
            excelData.push([
                'No',
                'Tanggal',
                'Kelas',
                'Mata Pelajaran',
                'Jam Mulai',
                'Jam Selesai', 
                'Materi',
                'Status',
                'Tidak Hadir',
                'Catatan'
            ]);
            
            // Tambahkan baris data
            filteredData.forEach((item, index) => {
                excelData.push([
                    index + 1,
                    formatDate(item.tanggal),
                    item.kelas,
                    item.mata_pelajaran,
                    formatTime(item.jam_mulai),
                    formatTime(item.jam_selesai),
                    item.materi,
                    item.status,
                    item.tidak_hadir,
                    item.catatan
                ]);
            });
            
            // Buat workbook dan worksheet
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            
            // Atur lebar kolom
            const colWidths = [
                { wch: 5 },   // No
                { wch: 12 },  // Tanggal
                { wch: 10 },  // Kelas
                { wch: 25 },  // Mata Pelajaran
                { wch: 10 },  // Jam Mulai
                { wch: 10 },  // Jam Selesai
                { wch: 30 },  // Materi
                { wch: 12 },  // Status
                { wch: 20 },  // Tidak Hadir
                { wch: 25 }   // Catatan
            ];
            worksheet['!cols'] = colWidths;
            
            // Gaya header
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F81BD" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
            
            // Terapkan gaya header
            for (let col = 0; col < excelData[0].length; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellRef]) continue;
                worksheet[cellRef].s = headerStyle;
            }
            
            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Jurnal Pembelajaran');
            
            // Buat nama file dengan tanggal saat ini dan filter yang diterapkan
            const currentDate = new Date().toISOString().split('T')[0];
            const filterKelas = document.getElementById('filterKelas').value;
            const filterMapel = document.getElementById('filterMapel').value;
            let filename = `jurnal_pembelajaran`;
            if (filterKelas) filename += `_${filterKelas.replace(/\s/g, '_')}`;
            if (filterMapel) filename += `_${filterMapel.replace(/\s/g, '_')}`;
            filename += `_${currentDate}.xlsx`;
            
            // Simpan file
            XLSX.writeFile(workbook, filename);
            
            showAlert('Data Excel berhasil didownload!', 'success');
        }
    </script>
</body>
</html>
